# Task C4: Симуляция производственной линии для сейфов и часов

## Описание

Программа симулирует производственную линию для производства сейфов и часов. Каждый час производится из 5 единиц древесины и 10 единиц шестеренок, шестеренки производятся из железной руды и так далее.

## Требования

- Clojure 1.11+
- Leiningen (для сборки и тестирования)

## Структура проекта

```
task-c4/
├── src/
│   └── task_c4/
│       └── core.clj          # Основная реализация
├── project.clj               # Конфигурация Leiningen
└── README.md                 # Документация
```

## Архитектура

### Компоненты системы

1. **Storage (Хранилище)** - хранит товары в атоме и уведомляет фабрики о новых поставках
2. **Factory (Фабрика)** - производит товары из сырья, используя агент для обработки
3. **Source (Источник)** - производит сырье (руда, древесина) в отдельном потоке

### Производственная цепочка

```
Ore Mine (2 единицы каждые 1000 мс)
  ↓
Ore Storage
  ├→ Metal Factory (1 единица Metal из 10 Ore каждые 1000 мс)
  │   ↓
  │   Metal Storage
  │     ↓
  │     Safe Factory (1 Safe из 3 Metal каждые 3000 мс)
  │
  └→ Gears Factory (4 единицы Gears из 4 Ore каждые 1000 мс)
      ↓
      Gears Storage
        ↓
        Cuckoo-clock Factory (1 Cuckoo-clock из 5 Lumber + 10 Gears каждые 2000 мс)

Lumber Mill (5 единиц каждые 4000 мс)
  ↓
Lumber Storage
  ↓
Cuckoo-clock Factory
```

## Основные функции

### `storage`
Создает новое хранилище с атомом для хранения товаров и агентом для обработки уведомлений.

### `factory`
Создает новую фабрику с агентом для обработки уведомлений о новых товарах.

### `source`
Создает источник сырья, который производит товары в отдельном потоке.

### `supply-msg`
Сообщение для агента хранилища о добавлении товаров. Обновляет атом и уведомляет все зарегистрированные фабрики.

### `notify-msg`
**Реализованная функция** - сообщение для агента фабрики о новых товарах в хранилище:
- Пытается забрать необходимые товары из атома хранилища
- Обновляет внутренний буфер фабрики
- Запускает производственный цикл, когда накоплено достаточно товаров
- После завершения цикла удаляет использованные товары из буфера и уведомляет целевое хранилище

## Использование

### Запуск в REPL

```bash
lein repl
```

Затем в REPL:

```clojure
(require '[task-c4.core :refer :all])

;; Запуск производственной линии
(start)

;; Остановка производственной линии
(stop)
```

### Проверка ошибок агентов

```clojure
;; Проверка ошибок фабрики шестеренок
(agent-error (gears-factory :worker))

;; Проверка ошибок хранилища металла
(agent-error (metal-storage :worker))
```

## Особенности реализации

### Использование Agents и Atoms

- **Agents** используются для процессоров (фабрик) - обеспечивают асинхронную обработку сообщений
- **Atoms** используются в хранилищах для хранения количества товаров
- **Agents** также используются в хранилищах для обработки уведомлений о поставках

### Обработка нехватки ресурсов

Система корректно обрабатывает нехватку металла:
- Фабрики пытаются забрать товары по мере их поступления
- Если товаров недостаточно, буфер обновляется частично
- Производство запускается только когда накоплено достаточно всех необходимых товаров
- Оба финальных продукта (Safe и Cuckoo-clock) производятся, но с пониженной скоростью из-за нехватки металла

### Асинхронное производство

Производственный цикл выполняется в `future`, что позволяет:
- Не блокировать агент во время производства
- Параллельно обрабатывать несколько производственных циклов
- Корректно обрабатывать задержки производства

## Логирование

Хранилища могут логировать количество товаров при достижении определенных порогов:
- `notify-step` определяет шаг логирования
- Если `notify-step == 0`, логирование отключено
- Логи показывают время и количество товаров в хранилище

## Пример вывода

```
12.34.56.789 | Ore amount: 10
12.34.57.123 | Metal amount: 5
12.34.58.456 | Safe amount: 1
12.34.59.789 | Gears amount: 20
12.35.01.123 | Cuckoo-clock amount: 1
```

## Математика производства

### Производство Metal
- Требуется: 10 единиц Ore
- Производится: 1 единица Metal
- Время цикла: 1000 мс
- Ore поступает: 2 единицы каждые 1000 мс
- **Результат**: Metal производится медленнее, чем мог бы (нехватка Ore)

### Производство Safe
- Требуется: 3 единицы Metal
- Производится: 1 Safe
- Время цикла: 3000 мс
- Metal поступает: 1 единица каждые 1000 мс (при наличии Ore)
- **Результат**: Safe производится с пониженной скоростью из-за нехватки Metal

### Производство Cuckoo-clock
- Требуется: 5 единиц Lumber + 10 единиц Gears
- Производится: 1 Cuckoo-clock
- Время цикла: 2000 мс
- Lumber поступает: 5 единиц каждые 4000 мс
- Gears поступает: 4 единицы каждые 1000 мс (при наличии Ore)
- **Результат**: Cuckoo-clock производится с нормальной скоростью (достаточно ресурсов)

## Тестирование

Для проверки работы системы:

1. Запустите систему: `(start)`
2. Подождите некоторое время
3. Проверьте количество произведенных товаров в хранилищах
4. Проверьте логи для отслеживания производства
5. Остановите систему: `(stop)`

## Примечания

- Система работает асинхронно и продолжает производство до остановки
- При нехватке ресурсов производство замедляется, но не останавливается
- Все операции с атомами атомарны и безопасны для многопоточности
- Агенты обрабатывают сообщения последовательно для каждого агента

